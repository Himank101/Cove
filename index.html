<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEXUS // PUBLIC_VIEW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Pixelify+Sans:wght@400;500;700&display=swap");

      :root {
        --neon-green: #00ff41;
        --neon-dim: rgba(0, 255, 65, 0.3);
        --dark-bg: #050505;
        --quality-gold: #ffd700;
      }

      body {
        background-color: var(--dark-bg);
        color: var(--neon-green);
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
      }

      /* Typography */
      .font-pixel {
        font-family: "Pixelify Sans", sans-serif;
      }
      .text-dim {
        color: var(--neon-dim);
      }
      .text-gold {
        color: var(--quality-gold);
      }

      /* Visuals */
      .noise-bg {
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        z-index: 0;
        pointer-events: none;
        opacity: 0.3;
        mix-blend-mode: overlay;
      }
      .glass-nav {
        background: rgba(5, 5, 5, 0.9);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(0, 255, 65, 0.2);
      }

      /* List Items */
      .repo-item {
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(0, 255, 65, 0.1);
        position: relative;
        overflow: hidden;
      }
      .repo-item:hover {
        background: rgba(0, 255, 65, 0.05);
        padding-left: 1.25rem;
      }
      .repo-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--neon-green);
        transform: scaleY(0);
        transition: transform 0.1s steps(3);
      }
      .repo-item:hover::before {
        transform: scaleY(1);
      }

      .pixel-tag {
        font-family: "Pixelify Sans", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .view-active {
        background: var(--neon-green) !important;
        color: black !important;
      }

      /* Quality Pip Indicators */
      .quality-pip {
        width: 3px;
        height: 8px;
        background: #1a1a1a;
        display: inline-block;
        margin-right: 1px;
      }
      .quality-pip.filled {
        background: var(--neon-green);
      }
      .quality-pip.gold {
        background: var(--quality-gold);
        box-shadow: 0 0 5px var(--quality-gold);
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col relative selection:bg-neon selection:text-dark"
  >
    <div id="parallax-bg" class="noise-bg"></div>

    <!-- NAV -->
    <nav class="glass-nav sticky top-0 z-50 w-full">
      <div
        class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between gap-4"
      >
        <div class="flex items-center gap-2 font-pixel text-xl select-none">
          <span
            id="conn-status"
            class="w-2 h-2 bg-red-500 rounded-full"
            title="Connecting..."
          ></span>
          <span>NEXUS_DB</span>
        </div>

        <div class="flex gap-1 overflow-x-auto no-scrollbar">
          <button
            onclick="switchView('list')"
            id="btn-list"
            class="view-active font-pixel text-xs px-3 py-1 border border-neon transition-all uppercase"
          >
            Index
          </button>
          <button
            onclick="switchView('graph')"
            id="btn-graph"
            class="font-pixel text-xs px-3 py-1 border border-neon text-neon hover:bg-neon/10 transition-all uppercase"
          >
            Vis
          </button>
        </div>
      </div>
    </nav>

    <!-- VIEWS -->
    <div
      id="main-container"
      class="relative z-10 w-full max-w-7xl mx-auto p-0 md:p-6"
    >
      <!-- List View -->
      <div id="list-view">
        <div
          class="flex gap-2 mb-4 overflow-x-auto no-scrollbar"
          id="nav-filters"
        ></div>
        <input
          type="text"
          id="search-input"
          oninput="renderList()"
          class="w-full bg-black border border-neon/30 p-2 mb-4 text-neon font-pixel text-sm outline-none focus:border-neon"
          placeholder="SEARCH_DATABASE..."
        />

        <div
          class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-pixel text-dim border-b border-neon/20 mb-2"
        >
          <div class="col-span-5">RESOURCE_NAME</div>
          <div class="col-span-4">DESCRIPTOR</div>
          <div class="col-span-2">CLUSTER</div>
          <div class="col-span-1 text-right">QUAL</div>
        </div>
        <div id="items-list" class="flex flex-col pb-20"></div>

        <div id="empty-state" class="hidden py-32 text-center">
          <p class="font-pixel text-2xl text-neon/50 blink">
            /// ERR: NULL_RESULT ///
          </p>
        </div>
      </div>

      <!-- Graph View -->
      <div
        id="graph-view"
        class="hidden h-[80vh] border border-neon/20 relative bg-black/50"
      >
        <canvas id="network-canvas" class="w-full h-full block"></canvas>
        <div
          class="absolute top-4 left-4 text-xs font-pixel text-dim pointer-events-none bg-black/80 p-2 border border-neon/10"
        >
          > VISUALIZATION_MODE: ACTIVE<br />> NODE_SIZE = IMPACT_SCORE
        </div>
      </div>
    </div>

    <script>
      // Default Data (Fallback if server offline)
      const defaultItems = [
        {
          title: "React Docs",
          url: "https://react.dev",
          category: "DEV",
          impact: 95,
          description: "Official library docs.",
        },
        {
          title: "Tailwind CSS",
          url: "https://tailwindcss.com",
          category: "STYLE",
          impact: 90,
          description: "Utility-first framework.",
        },
        {
          title: "GitHub",
          url: "https://github.com",
          category: "REPO",
          impact: 98,
          description: "Version control.",
        },
      ];

      let items = [];
      let currentView = "list";
      let currentFilter = "ALL";

      document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        await fetchData();
        initParallax();
        renderAll();
      });

      // --- NETWORKING ---
      async function fetchData() {
        const statusDot = document.getElementById("conn-status");
        try {
          const res = await fetch("/api/items");
          if (!res.ok) throw new Error("Offline");
          items = await res.json();
          statusDot.className =
            "w-2 h-2 bg-neon rounded-full shadow-[0_0_10px_#00FF41]"; // Green
          statusDot.title = "System Online";
        } catch (e) {
          console.log("Using offline fallback.");
          const local = localStorage.getItem("nexus_items");
          items = local ? JSON.parse(local) : defaultItems;
          statusDot.className = "w-2 h-2 bg-yellow-500 rounded-full"; // Yellow
          statusDot.title = "Local Mode";
        }
      }

      // --- UI RENDERING ---
      function renderAll() {
        renderNav();
        renderList();
        if (currentView === "graph") initGraph();
      }

      function renderNav() {
        const counts = {};
        items.forEach(
          (i) => (counts[i.category] = (counts[i.category] || 0) + 1),
        );
        const cats = ["ALL", ...Object.keys(counts).sort()];
        document.getElementById("nav-filters").innerHTML = cats
          .map(
            (c) =>
              `<button onclick="setFilter('${c}')" class="px-3 py-1 text-xs font-pixel border ${currentFilter === c ? "bg-neon text-black" : "text-neon bg-transparent"}">${c}</button>`,
          )
          .join("");
      }

      function renderList() {
        const list = document.getElementById("items-list");
        const term = document
          .getElementById("search-input")
          .value.toLowerCase();
        list.innerHTML = "";

        const filtered = items.filter(
          (i) =>
            (currentFilter === "ALL" || i.category === currentFilter) &&
            i.title.toLowerCase().includes(term),
        );

        if (filtered.length === 0) {
          document.getElementById("empty-state").classList.remove("hidden");
        } else {
          document.getElementById("empty-state").classList.add("hidden");
        }

        filtered.forEach((i) => {
          const pips = Math.floor((i.impact || 50) / 10);
          let qHtml = "";
          for (let x = 0; x < 10; x++)
            qHtml += `<div class="quality-pip ${x < pips ? "filled" : ""} ${i.impact >= 90 && x < pips ? "gold" : ""}"></div>`;

          list.innerHTML += `
                <a href="${i.url}" target="_blank" class="repo-item group block px-4 py-3 no-underline">
                    <div class="md:grid md:grid-cols-12 md:gap-4 items-center">
                        <div class="md:col-span-5 flex items-center gap-2 font-bold text-sm truncate text-neon">${i.title}</div>
                        <div class="md:col-span-4 text-xs text-dim truncate font-mono">${i.description || "NO_DATA"}</div>
                        <div class="md:col-span-2"><span class="pixel-tag px-1 border border-neon/30 text-[10px] text-dim">${i.category}</span></div>
                        <div class="md:col-span-1 text-right opacity-50 group-hover:opacity-100 flex justify-end">${qHtml}</div>
                    </div>
                </a>`;
        });
      }

      function switchView(v) {
        currentView = v;
        document.getElementById("list-view").classList.add("hidden");
        document.getElementById("graph-view").classList.add("hidden");
        document
          .getElementById("btn-list")
          .classList.remove("view-active", "text-black");
        document.getElementById("btn-list").classList.add("text-neon");
        document
          .getElementById("btn-graph")
          .classList.remove("view-active", "text-black");
        document.getElementById("btn-graph").classList.add("text-neon");

        document.getElementById(v + "-view").classList.remove("hidden");
        document
          .getElementById("btn-" + v)
          .classList.add("view-active", "text-black");
        document.getElementById("btn-" + v).classList.remove("text-neon");

        if (v === "graph") initGraph();
      }

      function setFilter(c) {
        currentFilter = c;
        renderList();
        renderNav();
      }

      // --- VISUALS ---
      function initParallax() {
        const bg = document.getElementById("parallax-bg");
        document.addEventListener("mousemove", (e) => {
          bg.style.transform = `translate(${-((e.clientX / window.innerWidth) * 30)}px, ${-((e.clientY / window.innerHeight) * 30)}px)`;
        });
      }

      function initGraph() {
        const cvs = document.getElementById("network-canvas");
        cvs.width = cvs.parentElement.clientWidth;
        cvs.height = cvs.parentElement.clientHeight;
        const ctx = cvs.getContext("2d");
        const nodes = items.map((i) => ({
          x: Math.random() * cvs.width,
          y: Math.random() * cvs.height,
          vx: 0,
          vy: 0,
          ...i,
        }));

        function loop() {
          if (currentView !== "graph") return;
          ctx.clearRect(0, 0, cvs.width, cvs.height);
          nodes.forEach((n) => {
            n.x += n.vx;
            n.y += n.vy;
            n.vx *= 0.95;
            n.vy *= 0.95;
            n.vx += (cvs.width / 2 - n.x) * 0.002;
            n.vy += (cvs.height / 2 - n.y) * 0.002;
            ctx.fillStyle = n.impact >= 90 ? "#FFD700" : "#00FF41";
            ctx.beginPath();
            ctx.arc(n.x, n.y, 3 + n.impact / 20, 0, 6.28);
            ctx.fill();
          });
          requestAnimationFrame(loop);
        }
        loop();
      }
    </script>
  </body>
</html>
